<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>우리 반, 우리 동네</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Chosen Palette: Fresh Green & Earth -->
    <!-- Application Structure Plan: A single-page application with three main views managed by JavaScript: a personalized start screen, a core interactive novel screen, and a final dynamic analysis report screen. The flow is linear through the story, driven by user choices presented as buttons. Key educational terms trigger pop-up modals to facilitate learning without disrupting the narrative. This structure was chosen to transform the text-based report into an engaging, game-like experience for 5th graders, promoting active participation and reinforcing concepts through personalized feedback in the final report. -->
    <!-- Visualization & Content Choices: The source report is a narrative. Goal: Engagement and Education. Presentation: The story is presented as text chunks with interactive buttons for choices. Interaction: Clicking choices advances the story. Clicking highlighted keywords (styled <span> with an event listener) shows a modal with a definition. Justification: This method avoids breaking the story's flow, making learning contextual and 'on-demand'. The final report dynamically displays analysis corresponding to the user's specific choices, providing personalized educational feedback. Library/Method: Vanilla JS for all logic and DOM manipulation. No charts or complex visualizations needed. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
            padding-bottom: 80px; /* for footer */
            word-break: keep-all; /* 단어 단위로 줄바꿈 처리 */
        }
        .keyword {
            cursor: pointer;
            font-weight: bold;
            color: #15803d; /* green-700 */
            text-decoration: underline;
            text-decoration-style: dotted;
        }
        .prose {
            line-height: 1.75;
        }
        .choice-btn {
            transition: all 0.2s ease-in-out;
        }
        .choice-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out;
        }
        blockquote {
            border-left: 4px solid #4ade80; /* green-400 */
            padding-left: 1rem;
            margin: 1.5rem 0;
            color: #555;
            font-style: italic;
            background-color: #f7fee7; /* lime-50 */
        }
    </style>
</head>
<body class="text-slate-800">

    <div id="app-container" class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Start Screen -->
        <div id="start-screen" class="min-h-screen flex flex-col items-center justify-center">
            <div class="w-full bg-white/90 backdrop-blur-sm p-6 sm:p-8 rounded-2xl shadow-lg border border-slate-200">
                <h1 class="text-3xl sm:text-4xl font-bold text-center text-green-700 mb-2">우리 반, 우리 동네</h1>
                <p class="text-center text-stone-500 mb-8">지은이: 핑키네</p>
                <p class="text-center text-stone-600 mb-8 text-base sm:text-lg">이야기를 시작하기 전에, 당신의 정보를 알려주세요!<br>이야기 속 주인공이 되어 더 재미있게 즐길 수 있어요.</p>
                <div class="space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <input type="text" id="grade" placeholder="학년 (예: 5)" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition text-base sm:text-lg">
                        <input type="text" id="class" placeholder="반 이름 (예: 난초반)" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition text-base sm:text-lg">
                    </div>
                    <input type="text" id="name" placeholder="당신의 이름 (예: 홍길동)" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition text-base sm:text-lg">
                </div>
                <p class="text-xs text-center text-stone-500 mt-4">입력하지 않으면 '5학년 난초반, 홍길동'으로 시작돼요.</p>
                
                <div class="text-xs text-center text-stone-500 mt-6 bg-slate-100 p-3 rounded-lg border border-slate-200">
                    <p class="font-bold mb-1 text-stone-600">안심하세요!</p>
                    <p>입력하신 정보는 개인정보로 수집 및 활용되지 않으며, 현재 보고 계신 화면의 줄거리 구성에만 사용됩니다. 다른 기기나 사용자에게는 절대 전송되지 않습니다.</p>
                </div>

                <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <button id="continue-btn" class="hidden w-full bg-slate-600 text-white font-bold py-3 px-6 rounded-lg text-lg sm:text-xl choice-btn">이어하기</button>
                    <button id="start-btn" class="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg text-lg sm:text-xl choice-btn sm:col-span-1">처음부터 시작하기</button>
                </div>

            </div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="hidden">
            <div class="w-full bg-white/90 backdrop-blur-sm p-6 sm:p-10 rounded-2xl shadow-lg border border-slate-200">
                <div id="previous-choice-display" class="hidden mb-6 p-4 bg-green-50 border-l-4 border-green-500 text-green-800 rounded-r-lg text-base sm:text-lg"></div>
                <div id="story-text" class="prose prose-lg max-w-none mb-8 text-base sm:text-xl"></div>
                <div id="choices" class="grid grid-cols-1 gap-4"></div>
            </div>
        </div>

        <!-- Report Screen -->
        <div id="report-screen" class="hidden">
            <div class="w-full bg-white/90 backdrop-blur-sm p-6 sm:p-10 rounded-2xl shadow-lg border border-slate-200">
                <h2 class="text-2xl sm:text-3xl font-bold text-center text-green-700 mb-4">심층 분석 보고서</h2>
                <p class="text-center text-stone-600 mb-10 text-base sm:text-lg">당신의 선택이 어떤 의미를 가졌는지 함께 알아볼까요?</p>
                <div id="report-content" class="space-y-8 text-base sm:text-lg"></div>
                <button id="save-report-btn" class="w-full bg-sky-600 text-white font-bold py-3 px-6 rounded-lg mt-8 text-lg sm:text-xl choice-btn">결과 이미지로 저장하기</button>
                <button id="restart-btn" class="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg mt-4 text-lg sm:text-xl choice-btn">처음부터 다시하기</button>
                <a href="https://pinkylucky.tistory.com/" target="_blank" rel="noopener noreferrer" class="block w-full text-center bg-slate-600 text-white font-bold py-3 px-6 rounded-lg mt-4 text-lg sm:text-xl choice-btn hover:bg-slate-700">다른 이야기 살펴보기</a>
            </div>
        </div>

    </div>

    <!-- Modal for definitions -->
    <div id="modal-container" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden modal-backdrop">
        <div id="modal-content" class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 border border-slate-200 transform scale-95">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-xl sm:text-2xl font-bold text-green-700"></h3>
                <button id="modal-close-btn" class="text-stone-500 hover:text-stone-800 text-3xl leading-none">&times;</button>
            </div>
            <p id="modal-text" class="text-stone-700 text-base sm:text-lg"></p>
        </div>
    </div>

    <!-- Footer -->
    <footer class="fixed bottom-0 left-0 w-full bg-slate-100/80 backdrop-blur-sm py-3 px-4 text-center text-stone-500 border-t border-slate-200">
        <p class="text-sm">made by. 핑키네</p>
        <p class="text-xs mt-1">본 저작물은 원작자(핑키네)를 밝히는 전제로 교육용으로 자유롭게 배포, 공유 및 사용이 가능합니다.</p>
    </footer>

    <script>
        const startScreen = document.getElementById('start-screen');
        const gameScreen = document.getElementById('game-screen');
        const reportScreen = document.getElementById('report-screen');
        const startBtn = document.getElementById('start-btn');
        const continueBtn = document.getElementById('continue-btn');
        const restartBtn = document.getElementById('restart-btn');
        const saveReportBtn = document.getElementById('save-report-btn');

        const storyTextEl = document.getElementById('story-text');
        const choicesEl = document.getElementById('choices');
        const prevChoiceDisplay = document.getElementById('previous-choice-display');

        const modalContainer = document.getElementById('modal-container');
        const modalContent = document.getElementById('modal-content');
        const modalTitle = document.getElementById('modal-title');
        const modalText = document.getElementById('modal-text');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        let currentSceneId = 0;
        let userInfo = {
            grade: '5',
            class: '난초반',
            name: '홍길동',
        };

        let userChoices = {
            c1: null,
            c2: null,
            c3: null
        };
        
        const definitions = {
            '환경 보전': { title: '환경 보전(環境保全)', text: '자연 환경을 아끼고 보호하여, 앞으로도 우리가 쾌적한 환경에서 살아갈 수 있도록 노력하는 것을 말해요. 우리 모두가 함께 지켜야 할 중요한 의무랍니다.' },
            '공청회': { title: '공청회(公聽會)', text: '나라나 지역에서 중요한 일을 결정하기 전에, 전문가나 주민들의 의견을 직접 듣기 위해 여는 공개적인 회의를 말해요.' },
            '지방 자치 단체': { title: '지방 자치 단체', text: '우리 동네의 살림을 맡아서 하는 공공 기관이에요. 시청, 구청, 군청 등이 여기에 속하며, 우리 지역의 문제를 해결하고 발전시키는 역할을 해요.' },
            '참정권': { title: '참정권(參政權)', text: '국민이 나라의 정치에 참여할 수 있는 권리예요. 선거에 참여하거나, 나라의 중요한 일에 의견을 내는 활동 등이 포함돼요.' },
            '청원': { title: '청원(請願)', text: '국민이 국가 기관에 자신의 의견이나 희망 사항을 문서로 전달하여, 문제 해결을 요구하는 것을 말해요. 참정권의 한 종류랍니다.'},
            '공익': { title: '공익(公益)', text: '한 개인이나 일부 집단이 아닌, 사회 전체의 이익을 의미해요. 때로는 개인의 권리가 공익을 위해 일부 제한될 수도 있어요.' },
            '개발': { title: '개발(開發)', text: '토지나 자원 등을 새롭게 이용하여 더 편리하고 유용한 상태로 만드는 것을 말해요. 하지만 개발 과정에서 환경이 파괴될 수도 있어 신중한 고민이 필요해요.'},
            '권리': { title: '권리(權利)', text: '사람이라면 누구나 당연히 누려야 할 소중한 힘이에요. 태어나는 순간부터 자연스럽게 가지게 되는 것이랍니다.' },
            '의무': { title: '의무(義務)', text: '우리 모두가 더 좋은 사회를 만들기 위해 함께 지켜야 할 약속이나 책임이에요. 권리를 누리는 만큼, 다른 사람과 사회를 위해 해야 할 일이랍니다.' },
            '원칙': { title: '원칙(原則)', text: '어떤 행동이나 이론 등에서 일관되게 지켜야 하는 기본적인 규칙이나 법칙을 말해요.'},
            '재판': { title: '재판(裁判)', text: '다툼이 생겼을 때, 법에 따라 누가 옳고 그른지를 가리는 공식적인 절차를 말해요.'},
            '위반': { title: '위반(違反)', text: '법이나 규칙, 약속 등을 어기는 것을 뜻해요.'},
            '부당': { title: '부당(不當)', text: '이치에 맞지 않고 올바르지 않다는 뜻이에요. 억울한 일을 당했을 때 "그건 부당해!"라고 말할 수 있어요.'},
            '침해': { title: '침해(侵害)', text: '다른 사람의 권리나 물건, 땅 등을 함부로 해치거나 빼앗는 것을 말해요.'}
        };

        function interpolate(text) {
            return text
                .replace(/\[학년\]/g, userInfo.grade)
                .replace(/\[반 이름\]/g, userInfo.class)
                .replace(/\[이름\]/g, userInfo.name);
        }
        
        function parseTextWithKeywords(text) {
            const keywords = Object.keys(definitions);
            const regex = new RegExp(`(${keywords.join('|')})`, 'g');
            return text.replace(regex, `<span class="keyword" data-keyword="$1">$1</span>`);
        }

        const storyData = {
            0: {
                text: () => `**[학년]학년 [반 이름]** 친구들에게는 비밀 아지트가 있습니다. 바로 학교 뒤편 공원에 있는 커다란 느티나무입니다. 수백 년 동안 자리를 지켜온 느티나무는 시원한 그늘을 만들어주고, 아이들의 즐거운 웃음소리를 들어주는 든든한 친구였습니다.<br><br>그런데 어느 날, 공원에 '알림' 팻말이 세워졌습니다. '주차 공간 확보를 위해 공원 일부를 주차장으로 변경할 예정이며, 공원 중앙의 느티나무는 제거될 예정입니다.'<br><br>이 소식에 반 친구들은 큰 충격에 빠졌습니다. 민준이는 "말도 안 돼! 우리들의 추억이 담긴 곳인데!"라며 화를 냈고, 수진이는 "저 나무는 우리 동네의 역사야. 함부로 베어내면 안 돼."라며 안타까워했습니다. 교과서에서 배웠던 **환경 보전**의 **의무**가 떠오르며, 당신(**[이름]**)의 마음도 무거워졌습니다.`,
                choices: [
                    { text: '다음으로', next: 1 }
                ]
            },
            1: {
                text: () => `<h3>[선택 1] 우리의 목소리, 어떻게 전달할까?</h3><p>반 친구들은 느티나무를 지키기 위해 무엇이라도 해야 한다고 생각했습니다. 하지만 어떻게 시작해야 할지 막막했습니다. 그때, 당신이 속한 모둠에서 먼저 행동 계획을 세워보기로 했습니다.<br><br>"우리끼리 이야기만 해서는 아무것도 바뀌지 않아. 뭔가 행동을 해야 해!" 민준이가 주먹을 불끈 쥐며 말했습니다.<br>"하지만 무작정 찾아가는 것보다, 우리의 주장을 뒷받침할 근거를 찾는 게 먼저 아닐까?" 수진이가 차분하게 반박했습니다.<br><br>당신은 모둠의 방향을 정할 중요한 의견을 내야 합니다. 어떤 방법이 가장 효과적일까요?</p>`,
                choices: [
                    { text: "A. 감성에 호소하기: '느티나무를 살려주세요!' 피켓과 포스터를 만들어 캠페인을 벌인다.", next: 'scene_1A', id: 'A' },
                    { text: "B. 이성적으로 설득하기: 느티나무의 역사적, 환경적 가치를 조사하여 보고서를 만든다.", next: 'scene_1B', id: 'B' },
                    { text: "C. 직접 행동하기: 당장 구청에 찾아가서 항의하고 우리의 뜻을 전달한다.", next: 'scene_1C', id: 'C' }
                ],
                choiceId: 'c1'
            },
            'scene_1A': {
                text: () => `당신과 친구들은 색색의 마커와 스케치북으로 정성껏 포스터를 만들었습니다. '우리의 느티나무를 지켜주세요!', '주차장보다 초록 공원이 좋아요!' 같은 문구들이 교실을 가득 채웠습니다. 주말 아침, 당신과 친구들은 공원 입구에서 캠페인을 시작했습니다. 처음에는 어색했지만, 진심을 담아 외치는 목소리에 산책 나온 주민들이 하나둘 걸음을 멈추고 귀를 기울이기 시작했습니다.<br><br>한 할머니께서는 "어이구, 기특한지고. 나 어릴 적에도 저 나무 밑에서 소꿉놀이했단다."라며 눈시울을 붉혔습니다. 하지만 공원 앞 가게 주인아저씨는 "학생들, 마음은 알겠는데 장사하는 사람 입장도 생각해줘야지. 주차장이 생겨야 손님이 늘지 않겠어?"라며 쓴소리를 하기도 했습니다.`,
                next: 2
            },
            'scene_1B': {
                text: () => `당신과 친구들은 도서관과 인터넷을 오가며 느티나무에 대한 모든 것을 조사했습니다. 그 나무가 우리 동네가 생기기 전부터 자리를 지켜온 수호신 같은 존재라는 것, 수많은 새와 곤충들의 보금자리가 되어준다는 사실을 알게 되었습니다. 당신들은 이 내용을 바탕으로 '느티나무 보존의 필요성에 대한 보고서'를 작성하여 구청 민원실에 정식으로 제출했습니다.<br><br>보고서를 제출하자, 구청 담당자는 "학생들이 이런 생각을 다 하다니, 정말 대단하네요. 하지만 주차장 문제는 동네 상인들의 오랜 민원 사항이라... 쉽지 않은 문제입니다."라며 난처한 표정을 지었습니다.`,
                next: 2
            },
             'scene_1C': {
                text: () => `당신과 친구들은 직접 행동에 나서기로 했습니다. 서툰 솜씨로 구청장님께 보내는 편지를 쓰고, 다 함께 구청으로 향했습니다. 처음에는 어리다고 무시하던 어른들도, 또박또박 자신들의 생각을 말하는 당신들의 모습에 점차 진지한 표정으로 귀를 기울이기 시작했습니다. 하지만 담당자는 "학생들의 마음은 잘 알겠습니다. 하지만 이건 어른들의 복잡한 사정이 얽혀있는 문제라, 학생들이 나설 일이 아닙니다."라며 선을 그었습니다.`,
                next: 2
            },
            2: {
                text: () => `<h3>[선택 2] 더 큰 힘을 모으기 위하여</h3><p>당신의 모둠이 시작한 활동은 동네에 작은 파장을 일으켰습니다. 어른들도 하나둘 관심을 갖기 시작했고, 마침내 **지방 자치 단체**인 구청에서 주민들의 의견을 듣기 위한 **공청회**를 열겠다고 발표했습니다.<br><br>이제는 우리 반만의 문제가 아닙니다. 더 많은 주민들을 설득하고, 우리의 주장에 힘을 실어야 합니다. **공청회**에서 우리 동네의 미래를 결정할 어른들의 마음을 움직이려면 어떻게 해야 할까요?</p>`,
                choices: [
                    { text: "A. 권리를 주장하자: '쾌적한 환경에서 살 권리'를 침해하는 부당한 개발이라고 주장한다.", next: 3, id: 'A' },
                    { text: "B. 대안을 제시하자: 주차장을 만들 다른 장소를 찾아내거나, 나무를 살리는 주차장 설계도를 제안한다.", next: 3, id: 'B' },
                    { text: "C. 여론을 만들자: 동네 주민들에게 서명을 받아, 많은 사람이 반대한다는 것을 보여준다.", next: 3, id: 'C' }
                ],
                choiceId: 'c2'
            },
            3: {
                text: () => `<h3>[선택 3] 마지막 기회, 우리의 최종 선택은?</h3><p>드디어 **공청회** 날. 당신과 친구들은 주민 대표 자격으로 단상에 섰습니다. 구청 담당자는 "주차난 해결은 우리 지역의 시급한 과제입니다. 주민 편의를 위한 불가피한 결정임을 이해해주시기 바랍니다."라며 주차장 건설의 필요성을 설명했습니다. 이어서 공원 앞 가게 주인이 마이크를 잡았습니다. "나무도 중요하지만, 먹고 사는 문제도 중요합니다! 주차장이 생겨야 우리 동네 상권이 삽니다!"<br><br>이제 당신에게 마지막 발언 기회가 주어졌습니다. 당신의 마지막 한마디가 느티나무의 운명을 결정할지도 모릅니다.</p>`,
                choices: [
                    { text: "A. 타협안 제시: '나무를 베지 말고, 비용이 더 들더라도 다른 곳으로 옮겨주세요.'", next: 'end_A', id: 'A' },
                    { text: "B. 강경한 반대: '어떤 이유로도 우리의 나무를 포기할 수 없습니다. 주차장 계획을 전면 취소해주세요.'", next: 'end_B', id: 'B' },
                    { text: "C. 새로운 비전 제시: '주차장 대신, 이 공원을 우리 동네의 자랑인 '생태 공원'으로 함께 만들어요!'", next: 'end_C', id: 'C' }
                ],
                choiceId: 'c3'
            },
            'end_A': {
                text: () => `<h4>결말 A: 현실적인 타협, 그러나 남는 아쉬움</h4><p>당신의 타협안은 공청회에 참석한 많은 주민들의 공감을 얻었습니다. "나무도 살리고, 주차장도 만들고! 좋은 생각이네!" 여기저기서 박수가 터져 나왔습니다. 며칠 후, 구청은 당신의 제안을 받아들여 많은 비용을 들여 느티나무를 공원 한쪽으로 옮기고, 원래 자리에 주차장을 만들었습니다.<br><br>느티나무는 살아남았고, 동네 주차 문제도 해결되었습니다. 하지만 원래 있던 자리를 떠난 느티나무는 어딘지 모르게 외로워 보였고, 예전처럼 시원한 그늘을 만들어주지는 못했습니다. 당신과 친구들은 나무를 지켰다는 사실에 안도하면서도, 마음 한편에 남는 아쉬움을 지울 수 없었습니다.</p>`,
                choices: [{ text: '심층 분석 보고서 보기', action: 'showReport' }]
            },
            'end_B': {
                text: () => `<h4>결말 B: 신념을 지켰지만, 깊어진 갈등</h4><p>당신의 단호한 외침은 공청회장을 술렁이게 만들었습니다. "학생들이 뭘 안다고!", "우리도 좀 편하게 살아보자!" 일부 주민들의 거센 반발에 부딪혔습니다. 결국 공청회는 뚜렷한 결론을 내리지 못한 채 끝났고, 동네 주민들은 '느티나무 파'와 '주차장 파'로 나뉘어 서로를 비난하기 시작했습니다.<br><br>시간이 흘러, 주차장 계획은 일단 보류되었습니다. 느티나무는 지켜냈지만, 동네에는 보이지 않는 벽이 생겼고, 이웃 간의 따뜻한 정은 사라졌습니다. 당신은 소중한 가치를 지키기 위해 용기를 냈지만, 그 결과는 모두에게 깊은 상처로 남았습니다.</p>`,
                choices: [{ text: '심층 분석 보고서 보기', action: 'showReport' }]
            },
            'end_C': {
                text: () => `<h4>결말 C: 새로운 도전, 그리고 또 다른 숙제</h4><p>당신의 제안은 공청회에 모인 사람들에게 신선한 충격을 주었습니다. '주차장'이라는 한 가지 생각에만 갇혀 있던 어른들은 '생태 공원'이라는 새로운 가능성에 대해 이야기하기 시작했습니다. "생태 공원이 생기면 아이들이 더 좋아하겠네!", "다른 동네에서도 우리 공원을 보러 오지 않을까?"<br><br>하지만 가게 주인아저씨는 "생태 공원 좋습니다. 그런데 그 공원에 사람들이 찾아오려면 차는 어디에 댑니까? 결국 주차장 문제는 그대로 남는 것 아닙니까?"라며 날카롭게 지적했습니다. 당신의 멋진 제안은 새로운 희망을 주었지만, 동시에 해결해야 할 또 다른 숙제를 남겼습니다. 우리 동네의 진짜 문제는 무엇이었을까요?`,
                choices: [{ text: '심층 분석 보고서 보기', action: 'showReport' }]
            }
        };

        const reportContent = {
            intro: `<h3>[<span class="player-grade"></span>학년 <span class="player-class"></span> '우리 동네를 지켜라!' 심층 분석 보고서]</h3><p class="mt-2 text-stone-600">플레이어 '<b class="player-name"></b>'님이 선택하고 경험한 사건들은 우리 사회를 움직이는 중요한 원리와 연결되어 있습니다.</p>`,
            c1: {
                title: '분석 1: 우리의 목소리, 어떻게 전달했을까?',
                A: `<h4>당신은 <span class="text-teal-600 font-bold">'감성에 호소하기'</span>를 선택했어요.</h4><p class="mt-2 text-stone-600">피켓과 포스터를 통해 느티나무의 소중함을 알리는 캠페인을 벌였군요. 이는 사람들의 마음에 직접 호소하여 공감대를 형성하는 방법으로, 사회 문제에 대한 시민들의 관심을 이끌어내는 효과적인 **시민 운동**의 시작입니다.</p>`,
                B: `<h4>당신은 <span class="text-teal-600 font-bold">'이성적으로 설득하기'</span>를 선택했어요.</h4><p class="mt-2 text-stone-600">객관적인 자료와 보고서를 통해 주장의 논리적 근거를 마련했군요. 감정적인 호소만큼이나, 타당한 근거를 제시하는 것은 정책 결정 과정에서 상대방을 설득하는 데 매우 중요한 역할을 합니다.</p>`,
                C: `<h4>당신은 <span class="text-teal-600 font-bold">'직접 행동하기'</span>를 선택했어요.</h4><p class="mt-2 text-stone-600">문제를 발견했을 때, 주저하지 않고 직접 담당 기관에 찾아가 목소리를 내는 용기를 보여주었군요. 이는 자신의 **권리**를 지키기 위한 적극적인 행동이자, **참정권** 행사의 중요한 첫걸음입니다.</p>`
            },
            c2: {
                title: '분석 2: 더 큰 힘을 모으기 위한 전략',
                A: `<h4>당신은 <span class="text-teal-600 font-bold">'권리를 주장'</span>하는 방법을 택했어요.</h4><p class="mt-2 text-stone-600">쾌적한 환경에서 살 **권리**가 **개발** 논리보다 우선되어야 한다고 주장했군요. 헌법이 보장하는 국민의 기본권을 근거로 정책의 부당함을 지적하는 것은, 민주 사회 시민의 중요한 역할입니다.</p>`,
                B: `<h4>당신은 <span class="text-teal-600 font-bold">'대안을 제시'</span>하는 방법을 택했어요.</h4><p class="mt-2 text-stone-600">단순한 반대를 넘어, 문제를 해결할 수 있는 창의적인 대안을 제시했군요. 이는 비판에서 그치지 않고, 문제 해결에 직접 참여하는 성숙한 시민 의식을 보여줍니다. 정책은 더 좋은 대안이 있을 때 바뀔 가능성이 커집니다.</p>`,
                C: `<h4>당신은 <span class="text-teal-600 font-bold">'여론을 만드는'</span> 방법을 택했어요.</h4><p class="mt-2 text-stone-600">**청원**을 위한 서명 운동을 통해, 이 문제가 나 혼자만의 생각이 아닌 많은 주민의 뜻임을 보여주었군요. 민주주의 사회에서 여론은 정책 결정에 큰 영향을 미칩니다. 이는 **참정권**을 효과적으로 행사하는 방법 중 하나입니다.</p>`
            },
            c3: {
                title: '분석 3: 최종 결정의 의미',
                A: `<h4>당신은 <span class="text-teal-600 font-bold">'타협안'</span>을 제시했어요.</h4><p class="mt-2 text-stone-600">**개발**의 필요성과 **환경 보전**이라는 두 가지 **가치**가 충돌할 때, 양쪽 모두의 의견을 존중하여 절충안을 찾는 현실적인 방법을 선택했습니다. 이는 사회적 갈등을 해결하는 중요한 지혜입니다.</p>`,
                B: `<h4>당신은 <span class="text-teal-600 font-bold">'강경한 반대'</span>를 선택했어요.</h4><p class="mt-2 text-stone-600">어떤 이유로도 포기할 수 없는 소중한 **가치**가 있다고 믿고, 끝까지 **원칙**을 지키려 했습니다. 때로는 이러한 확고한 신념이 더 큰 변화를 만들어 내기도 합니다.</p>`,
                C: `<h4>당신은 <span class="text-teal-600 font-bold">'새로운 비전'</span>을 제시했어요.</h4><p class="mt-2 text-stone-600">주어진 문제에만 갇히지 않고, 모두가 더 행복해질 수 있는 새로운 상상력을 보여주었군요. 이는 단순한 반대를 넘어, 지역 사회의 미래를 함께 만들어가는 '주인'으로서의 시민 역할을 보여주는 가장 멋진 모습입니다.</p>`
            },
            conclusion: (endingKey) => {
                let text = "";
                switch(endingKey) {
                    case 'A':
                        text = `<h4>결론: 🌳 당신은 <span class="text-teal-600 font-bold">'현실적인 중재자'</span>입니다.</h4><p class="mt-2 text-stone-600">당신은 양쪽의 입장을 모두 고려하여 가장 현실적인 해결책을 찾아냈습니다. 덕분에 느티나무는 목숨을 구했고, 주민들은 주차 공간도 얻게 되었습니다. 하지만 이 과정에서 더 좋은 대안을 찾을 기회를 놓쳤을 수도 있다는 아쉬움이 남습니다.</p>`;
                        break;
                    case 'B':
                        text = `<h4>결론: ✊ 당신은 <span class="text-teal-600 font-bold">'신념을 지키는 활동가'</span>입니다.</h4><p class="mt-2 text-stone-600">당신은 소중한 가치를 위해 끝까지 타협하지 않는 용기를 보여주었습니다. 비록 당장 원하는 결과를 얻지는 못했지만, 당신의 외침은 많은 사람의 마음에 깊은 울림을 남겼고, 미래에 더 좋은 결정을 내릴 수 있는 씨앗이 되었습니다.</p>`;
                        break;
                    case 'C':
                        text = `<h4>결론: ✨ 당신은 <span class="text-teal-600 font-bold">'미래를 만드는 혁신가'</span>입니다.</h4><p class="mt-2 text-stone-600">당신은 갈등을 더 나은 미래를 만드는 기회로 바꾸는 놀라운 지혜를 보여주었습니다. 하지만 당신의 멋진 제안이 모든 문제를 해결해주지는 못했습니다. 주차장 문제는 여전히 해결해야 할 숙제로 남았고, 좋은 의도의 **개발** 계획도 또 다른 갈등을 낳을 수 있다는 점을 배우게 되었습니다. 이 경험은 사회 문제가 하나의 정답으로 해결되지 않는다는 중요한 교훈을 줍니다.</p>`;
                        break;
                }
                return text;
            }
        };

        function getEndingContent(endingKey) {
            const scene = storyData[`end_${endingKey}`];
            return {
                title: scene.text().match(/<h4>(.*?)<\/h4>/)[1],
                positive: scene.text().match(/<p>(.*?)<\/p>/)[1],
                sideEffect: scene.text().match(/<p class="text-stone-600 italic">(.*?)<\/p>/)[1]
            };
        }

        function showScene(sceneId, previousChoiceText = null, endingKey = null) {
            currentSceneId = sceneId;
            const scene = storyData[sceneId];
            if (!scene) return;

            if (previousChoiceText) {
                prevChoiceDisplay.innerHTML = `<p class="italic">▶ 당신의 선택: ${previousChoiceText}</p>`;
                prevChoiceDisplay.classList.remove('hidden');
            } else {
                prevChoiceDisplay.classList.add('hidden');
            }
            
            let text = scene.text();

            let htmlText = interpolate(text).replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            storyTextEl.innerHTML = parseTextWithKeywords(htmlText);
            
            choicesEl.innerHTML = '';
            if (scene.choices) {
                scene.choices.forEach(choice => {
                    const button = document.createElement('button');
                    const choiceText = interpolate(choice.text);
                    button.innerHTML = parseTextWithKeywords(choiceText);
                    button.className = 'w-full text-left bg-white border border-green-500 text-green-700 font-semibold py-3 px-5 rounded-lg text-base sm:text-lg choice-btn hover:bg-green-50';
                    
                    if (choice.action === 'showReport') {
                        button.addEventListener('click', () => showReport(endingKey));
                    } else {
                        button.addEventListener('click', () => {
                            if (scene.choiceId) {
                                userChoices[scene.choiceId] = choice.id;
                            }
                            showNextScene(choice.next, choiceText);
                        });
                    }
                    choicesEl.appendChild(button);
                });
            } else if(scene.next) {
                 const nextButton = document.createElement('button');
                nextButton.textContent = '다음으로';
                nextButton.className = 'w-full text-center bg-green-600 text-white font-semibold py-3 px-5 rounded-lg text-base sm:text-lg choice-btn hover:bg-green-700';
                nextButton.addEventListener('click', () => {
                    showNextScene(scene.next, null);
                });
                choicesEl.appendChild(nextButton);
            }

            saveGameState();
            window.scrollTo(0, 0);
        }
        
        function showNextScene(nextSceneId, choiceText) {
            if (typeof nextSceneId === 'string' && nextSceneId.startsWith('end_')) { 
                const endingKey = nextSceneId.split('_')[1];
                showEndingScene(endingKey, choiceText);
                clearGameState(); 
            } else {
                showScene(nextSceneId, choiceText);
            }
        }

        function showEndingScene(endingKey, choiceText) {
            const sceneKey = `end_${endingKey}`;
            currentSceneId = sceneKey; // Store the specific ending scene key
            const scene = storyData[sceneKey];
            
            if (choiceText) {
                prevChoiceDisplay.innerHTML = `<p class="italic">▶ 당신의 선택: ${choiceText}</p>`;
                prevChoiceDisplay.classList.remove('hidden');
            }

            storyTextEl.innerHTML = parseTextWithKeywords(interpolate(scene.text()));

            choicesEl.innerHTML = '';
            const reportButton = document.createElement('button');
            reportButton.className = "w-full text-left bg-green-500 text-white font-semibold py-3 px-5 rounded-lg text-base sm:text-lg choice-btn hover:bg-green-600";
            reportButton.textContent = '심층 분석 보고서 보기';
            reportButton.onclick = () => showReport(endingKey);
            choicesEl.appendChild(reportButton);
        }

        function determineEnding() {
            return userChoices.c3;
        }

        function showReport(endingKey) {
            gameScreen.classList.add('hidden');
            reportScreen.classList.remove('hidden');

            const reportEl = document.getElementById('report-content');
            
            let reportHtml = `<div class="bg-lime-50 p-6 rounded-lg border border-lime-200">${interpolate(reportContent.intro)}</div>`;
            reportHtml += `<div class="bg-slate-50 p-6 rounded-lg border border-slate-200"><h4 class="font-bold text-green-700">${reportContent.c1.title}</h4>${interpolate(reportContent.c1[userChoices.c1] || '')}</div>`;
            reportHtml += `<div class="bg-slate-50 p-6 rounded-lg border border-slate-200"><h4 class="font-bold text-green-700">${reportContent.c2.title}</h4>${interpolate(reportContent.c2[userChoices.c2] || '')}</div>`;
            reportHtml += `<div class="bg-slate-50 p-6 rounded-lg border border-slate-200"><h4 class="font-bold text-green-700">${reportContent.c3.title}</h4>${interpolate(reportContent.c3[userChoices.c3] || '')}</div>`;
            reportHtml += `<div class="bg-lime-50 p-6 rounded-lg border border-lime-200">${interpolate(reportContent.conclusion(endingKey))}</div>`;
            
            reportEl.innerHTML = parseTextWithKeywords(reportHtml);
            
            reportEl.querySelector('.player-grade').textContent = userInfo.grade;
            reportEl.querySelector('.player-class').textContent = userInfo.class;
            reportEl.querySelector('.player-name').textContent = userInfo.name;

            window.scrollTo(0, 0);
        }

        function showModal(keyword) {
            const definition = definitions[keyword];
            if (definition) {
                modalTitle.textContent = definition.title;
                modalText.textContent = definition.text;
                modalContainer.classList.remove('hidden');
                setTimeout(() => {
                    modalContainer.classList.add('opacity-100');
                    modalContent.classList.add('scale-100');
                    modalContent.classList.remove('scale-95');
                }, 10);
            }
        }
        
        function hideModal() {
            modalContainer.classList.remove('opacity-100');
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            setTimeout(() => {
                modalContainer.classList.add('hidden');
            }, 300);
        }

        function saveGameState() {
            const gameState = {
                userInfo: userInfo,
                userChoices: userChoices,
                currentSceneId: currentSceneId,
                lastChoiceText: prevChoiceDisplay.innerHTML
            };
            localStorage.setItem('interactiveNovelSaveData_v4', JSON.stringify(gameState));
        }

        function loadGameState() {
            const savedData = localStorage.getItem('interactiveNovelSaveData_v4');
            if (savedData) {
                continueBtn.classList.remove('hidden');
                startBtn.classList.add('sm:col-span-1');
                startBtn.innerText = "처음부터 시작하기";
                if(window.innerWidth < 640) {
                     continueBtn.classList.add('sm:col-span-2');
                     startBtn.classList.add('sm:col-span-2');
                } else {
                    continueBtn.classList.remove('sm:col-span-2');
                    startBtn.classList.remove('sm:col-span-2');
                }
            } else {
                 startBtn.classList.remove('sm:col-span-1');
                 startBtn.classList.add('sm:col-span-2');
                 startBtn.innerText = "이야기 시작하기";
            }
        }

        function clearGameState() {
             localStorage.removeItem('interactiveNovelSaveData_v4');
             continueBtn.classList.add('hidden');
             loadGameState();
        }

        startBtn.addEventListener('click', () => {
            clearGameState();

            userInfo.grade = document.getElementById('grade').value || '5';
            userInfo.class = document.getElementById('class').value || '난초반';
            userInfo.name = document.getElementById('name').value || '홍길동';
            
            userChoices = { c1: null, c2: null, c3: null };

            startScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            showScene(0);
        });
        
        continueBtn.addEventListener('click', () => {
            const savedData = JSON.parse(localStorage.getItem('interactiveNovelSaveData_v4'));
            if(savedData) {
                userInfo = savedData.userInfo;
                userChoices = savedData.userChoices;
                currentSceneId = savedData.currentSceneId;
                const lastChoiceTextHtml = savedData.lastChoiceText;

                startScreen.classList.add('hidden');
                gameScreen.classList.remove('hidden');
                
                let endingKey = null;
                if (typeof currentSceneId === 'string' && currentSceneId.startsWith('end_')) {
                    endingKey = currentSceneId.split('_')[1];
                }
                showScene(currentSceneId, lastChoiceTextHtml, endingKey);
            }
        });

        restartBtn.addEventListener('click', () => {
            clearGameState();
            userChoices = { c1: null, c2: null, c3: null };
            reportScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
            window.scrollTo(0, 0);
        });
        
        saveReportBtn.addEventListener('click', () => {
            const reportEl = document.getElementById('report-content');
            const originalBgColor = reportEl.style.backgroundColor;
            reportEl.style.backgroundColor = 'white'; 

            html2canvas(reportEl).then(canvas => {
                reportEl.style.backgroundColor = originalBgColor;
                const image = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = image;
                link.download = `${userInfo.grade}학년_${userInfo.class}_${userInfo.name}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        });
        
        document.body.addEventListener('click', (e) => {
            if (e.target.classList.contains('keyword')) {
                showModal(e.target.dataset.keyword);
            }
        });

        modalCloseBtn.addEventListener('click', hideModal);
        modalContainer.addEventListener('click', (e) => {
            if (e.target === modalContainer) {
                hideModal();
            }
        });

        window.addEventListener('resize', loadGameState);
        window.addEventListener('load', loadGameState);

    </script>
</body>
</html>
